<? 
	include "include/config.inc";

#	PARAMETERS:
	
#	itemid
#	type

	if(!isset($period))
	{
		$period=0;
	}

	if(!isset($from))
	{
		$from=0;
	}

	$sizeX=900;
	$sizeY=200;

	$shiftX=10;
	$shiftY=10;

	$space_for_text=50;

	$nodata=1;	


//	Header( "Content-type:  text/html"); 
	Header( "Content-type:  image/png"); 
	Header( "Expires:  Mon, 17 Aug 1998 12:51:50 GMT"); 

	$im = imagecreate($sizeX+$shiftX+61,$sizeY+2*$shiftY+$space_for_text+10); 
  
	$red=ImageColorAllocate($im,255,0,0); 
	$green=ImageColorAllocate($im,0,255,0); 
	$darkgreen=ImageColorAllocate($im,0,150,0); 
	$blue=ImageColorAllocate($im,0,0,255); 
	$yellow=ImageColorAllocate($im,255,255,0); 
	$cyan=ImageColorAllocate($im,0,255,255); 
	$black=ImageColorAllocate($im,0,0,0); 

	$x=imagesx($im); 
	$y=imagesy($im);
  
	ImageFilledRectangle($im,0,0,$sizeX+$shiftX+61,$sizeY+2*$shiftY+$space_for_text+10,$black);

	for($i=0;$i<=$sizeY;$i+=50)
	{
		ImageDashedLine($im,$shiftX,$i+$shiftY,$sizeX+$shiftX,$i+$shiftY,$darkgreen);
	}
	for($i=0;$i<=$sizeX;$i+=50)
	{
		ImageDashedLine($im,$i+$shiftX,$shiftY,$i+$shiftX,$sizeY+$shiftY,$darkgreen);
	}

	$now = time(NULL);

	$count=array();
	$min=array();
	$max=array();
	$avg=array();
	for($i=0;$i<100;$i++)
	{
		$result=DBselect("select count(value),min(value),max(value),avg(value) from history where itemid=$itemid and clock>$now-($i+1)*60 and clock<$now-$i*60");
		$count[99-$i]=DBget_field($result,0,0);
		$min[99-$i]=DBget_field($result,0,1);
		$max[99-$i]=DBget_field($result,0,2);
		$avg[99-$i]=DBget_field($result,0,3);
	}
	$len=0;
	$maxY=-1000000000;
	$minY=1000000000;
	for($i=0;$i<100;$i++)
	{
		$nodata=0;
		if($max[$i]>$maxY) { $maxY=$max[$i]; }
		if(($max[$i]<$minY)&&($count[$i]>0)) { $minY=$max[$i]; }
		$len++;
	}
	$maxX=800;
	$minX=0;
//	echo "MIN/MAX:",$minX," - ",$maxX," - ",$minY," - ",$maxY,"<Br>";

	if(($minX!=$maxX)&&($minY!=$maxY))
	{
		for($i=0;$i<100;$i++)
		{
			$x1=8*$sizeX*($i-$minX)/($maxX-$minX);
			$y1=$sizeY*($max[$i]-$minY)/($maxY-$minY);
			$x2=$x1;
			$y2=0;
			$y1=$sizeY-$y1;
			$y2=$sizeY-$y2;

			ImageFilledRectangle($im,$x1+$shiftX,$y1+$shiftY,$x2+$shiftX+8,$y2+$shiftY,$red);

			$x1=8*$sizeX*($i-$minX)/($maxX-$minX);
			$y1=$sizeY*($avg[$i]-$minY)/($maxY-$minY);
			$x2=$x1;
			$y2=0;
			$y1=$sizeY-$y1;
			$y2=$sizeY-$y2;

			ImageFilledRectangle($im,$x1+$shiftX,$y1+$shiftY,$x2+$shiftX+8,$y2+$shiftY,$yellow);

			$x1=8*$sizeX*($i-$minX)/($maxX-$minX);
			$y1=$sizeY*($min[$i]-$minY)/($maxY-$minY);
			$x2=$x1;
			$y2=0;
			$y1=$sizeY-$y1;
			$y2=$sizeY-$y2;

			ImageFilledRectangle($im,$x1+$shiftX,$y1+$shiftY,$x2+$shiftX+8,$y2+$shiftY,$green);

			ImageStringUp($im, 1, $x1+10, $sizeY+$shiftY+$space_for_text+15, "123456789012" , $red);
		}
	}
	else
	{
		ImageLine($im,$shiftX,$shiftY+$sizeY/2,$sizeX+$shiftX,$shiftY+$sizeY/2,$green);
	}

	if($nodata == 0)
	{
		for($i=0;$i<=$sizeY;$i+=50)
		{
			ImageString($im, 1, $sizeX+5+$shiftX, $sizeY-$i-4+$shiftY, $i*($maxY-$minY)/$sizeY+$minY , $red);
		}

//		date("dS of F Y h:i:s A",DBget_field($result,0,0));

//		ImageString($im, 1,10,                $sizeY+$shiftY+5, date("dS of F Y h:i:s A",$minX) , $red);
//		ImageString($im, 1,$sizeX+$shiftX-168,$sizeY+$shiftY+5, date("dS of F Y h:i:s A",$maxX) , $red);
	}
	else
	{
		ImageString($im, 2,$sizeX/2 -50,                $sizeY+$shiftY+3, "NO DATA FOR THIS PERIOD" , $red);
	}

	ImagePng($im); 
	ImageDestroy($im); 
?>
